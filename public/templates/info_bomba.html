<!DOCTYPE html>
<html lang="pt">


<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="/css/my_styling.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">
    
    <title>Informação sobre a Bomba de Combustível</title>
</head>


<body class="bg-secondary">

   <!-- Navbar -->
   <nav class="navbar navbar-expand-lg navbar-dark border-bottom border-3 border-info">
    <div class="container-fluid mt-2 ml-3 d-flex justify-content-between">
        <a class="navbar-brand" href="/">
            <h2>
                <strong class="text-info">
                    &nbsp;&nbsp;&nbsp; Combustíveis em Lisboa
                </strong>
            </h2>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse justify-content-end" id="navbarResponsive">
            <ul class="navbar-nav">
                <li><a class="nav-link mx-2 toggle-warning" href="#" id="logout" data-bs-toggle="modal" data-bs-target="#logoutModal"><strong>Logout <i class="bi bi-door-open"></i></strong></a></li>
                <li><a class="nav-link mx-2 toggle-warning" href="#" id="login" data-bs-toggle="modal" data-bs-target="#loginModal"><strong>Login <i class="bi bi-person-check"></i></strong></a></li>
                <li><a class="nav-link mx-2 toggle-warning" href="#" id="registar" data-bs-toggle="modal" data-bs-target="#registarModal"><strong>Registar <i class="bi bi-person-plus"></i></strong></a></li>
                <li><a class="nav-link mx-2" href="/bp_galp"><strong>BP vs Galp</strong></a></li>
                <li><a class="nav-link mx-2" href="/comparador_bp"><strong>Comparador BP</strong></a></li>
                <li><a class="nav-link mx-2" href="/comparador_galp"><strong>Comparador GALP</strong></a></li>
                <li><a class="nav-link mx-2" href="/sobre"><strong>Sobre</strong></a></li>
            </ul>
        </div>
    </div>
</nav>

    <div class="content" id="content">
        <!-- Info da Bomba de Combustivel-->
        <div class="container col-lg-8" style="margin-top: 4%;">
            <div class="card shadow">
                <div class="card-body">
                    <div id="data">
                        <!-- Nome da Bomba de Combustivel -->
                        <h3 class="text-info"><strong id="nomeBomba"></strong></h3>
                        <hr class="text-info">
                        <div class="d-flex justify-content-between mb-4">
                            <!-- Informações Gerais da Bomba de Combustivel -->
                            <div class="col-lg-5 mx-3 mt-4">
                                <!-- Horario da Bomba -->
                                <p class="h6 mb-2 text-dark"><strong><i class="bi bi-clock"></i>&nbsp; Horário da Bomba: </strong></p>
                                <div class="loaderWrapper">
                                    <div class="loader">

                                    </div>
                                </div>
                                <div id="horario" class="row ml-2 mt-3">

                                </div>
                                <!-- Morada -->
                                <p class="h6 mb-2 mt-4 text-dark"><strong><i class="bi bi-building"></i>&nbsp;Morada: </strong></p>
                                <div class="row ml-2 mt-3" id="morada">

                                </div>
                            </div>
                            <!-- Preços dos Combustiveis -->
                            <div class="col-lg-7 mx-3 mt-4">
                                <p class="text-dark"><strong><i class="bi bi-currency-euro"></i>&nbsp;Preço dos Combustíveis:</strong></p>
                                <div class="row mt-1 mb-2">
                                    <!-- Gasóleo Simples-->
                                    <div class="col-lg-6 text-dark">
                                        <p><small>Gasóleo Simples</small></p>
                                        <p><strong id="gasoleo_simples"></strong></p>
                                    </div>
                                    <!-- Gasóleo Aditivado-->
                                    <div class="col-lg-6" style="color: #00bfe0;">
                                        <p><small>Gasóleo Aditivado</small></p>
                                        <p><strong id="gasoleo_aditivado"></strong></p>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <!-- Gasolina Simples-->
                                    <div class="col-lg-6 text-success">
                                        <p><small>Gasolina Simples</small></p>
                                        <p><strong id="gasolina_simples"></strong></p>
                                    </div>
                                    <!-- Gasolina Aditivada -->
                                    <div class="col-lg-6 text-danger">
                                        <p><small>Gasolina Aditivada</small></p>
                                        <p><strong id="gasolina_aditivada"></strong></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <!-- Gasolina 98 -->
                                    <div class="col-lg-12" style="color: #fff01d;">
                                        <p><small>Gasolina 98</small></p>
                                        <p><strong id="gasolina_98"></strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-2 mb-2">
                        <a class="nav-link border-0 mr-5 h6" style="cursor: pointer;" onclick="window.history.go(-1)"><strong>Voltar</strong></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="spinner-wrapper">
        <div class="spinner"></div>
    </div>
    
     <!-- Login Modal -->
     <div class="modal fade" id="loginModal" aria-labelledby="loginModal" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST">
                    <div class="modal-body border-0">
                        <div class="row border-0 d-flex justify-content-center mb-2 mt-3">
                            <h2 class="text-info text-center"><strong>Login <i class="bi bi-person-check"></strong></i></h2>
                        </div>
                        <hr class="text-info mx-auto w-50 mb-4">
                        <div class="row mx-2 d-flex justify-content-center">
                            <div class="col-lg-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="usernameLogin" placeholder="Username">
                                    <label for="floatingUsername">Username</label>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row mx-2 d-flex justify-content-center">
                            <div class="col-lg-8">
                                <div class="form-floating">
                                    <input type="password" class="form-control" id="passwordLogin" placeholder="Password">
                                    <label for="floatingPassword">Password</label>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="d-flex justify-content-center">
                            <div class="alert alert-warning toggle-warning col-lg-7" id="loginWarning" style="height: 10%;">
                                <strong>Utilizador não existe..</strong>
                            </div>
                            <div class="alert alert-warning toggle-warning col-lg-7" id="passwordLoginWarning" style="height: 10%;">
                                <strong>Password errada. Tente novamente.</strong>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2 d-flex justify-content-center">
                        <div class="d-grid col-7 mb-3 gap-2">
                            <button type="button" id="submitLogin" class="btn btn-info mx-3">Login</button>
                        </div>
                        <div class="d-grid col-7 mb-2 gap-2">
                            <button type="button" class="btn btn-outline-info mx-3" id="popUp" href="#" data-bs-toggle="modal" data-bs-target="#registarModal">Não tens conta? Regista-te aqui!</button> 
                        </div>
                        <div class="d-grid col-7 mb-2 gap-2 text-center">
                            <a class="nav-link" href="#" data-bs-dismiss="modal">Fechar</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registarModal" aria-labelledby="registarModal" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" id="registerForm">
                    <div class="modal-header border-0 d-flex justify-content-center mt-3">
                        <h2 class="text-info"><strong>Registar <i class="bi bi-person-plus"></strong></i></h2>
                    </div>
                    <div class="modal-body d-flex justify-content-center align-items-center border-0">
                        <div class="row w-100 d-flex justify-content-center">
                            <div class="col-lg-8">
                                <ul class="list-group list-group-flush" style="border-radius: 9px;">
                                    <li class="list-group-item"><small>É aconselhado o uso de uma password <strong>forte</strong>;</small></li>
                                    <li class="list-group-item"><small>Deve conter pelo menos <strong>8 caracteres</strong>;</small></li>
                                    <li class="list-group-item"><small>Deve conter caracteres <strong>alfanuméricos</strong> e/ou <strong>especiais</strong>.</small></li>
                                </ul>
                            </div>
                            <hr class="text-info mb-3 mt-3 mx-auto w-50">
                            <div class="col-lg-8">
                                <div class="form-floating">
                                    <input type="text" id="usernameRegister" class="form-control" placeholder="Username">
                                    <label for="floatingUsername">Username</label>
                                </div>
                                <br>
                                <div class="form-floating">
                                    <input type="password" id="passwordRegister" class="form-control" placeholder="Password">
                                    <label for="floatingPassword">Password</label>
                                </div>
                                <br>
                                <div class="alert alert-info toggle-warning" data-bs-dismiss="alert" id="alert">
                                    <small><strong>Registo efetuado com sucesso!</strong></small>
                                </div>
                                <div class="alert alert-warning toggle-warning" data-bs-dismiss="alert" id="warning">
                                    <small><strong>Preencha todos os campos</strong></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 mb-3 d-flex justify-content-center">
                        <div class="d-grid col-6 gap-2">
                            <button type="button" id="submitRegister" class="btn btn-info mx-3">Registar</button>
                        </div>
                        <div class="d-grid col-6 gap-2 text-center">
                            <a class="nav-link" href="#" data-bs-dismiss="modal">Fechar</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div class="modal fade" id="logoutModal" aria-labelledby="logoutModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0 d-flex justify-content-center">
                    <h2 class="text-info">Já de saída?</h2>
                </div>
                <div class="modal-body d-flex justify-content-center">
                    <div class="d-grid col-6 gap-2 mx-1">
                        <button class="btn btn-outline-info" href="#" data-bs-dismiss="modal">Fechar</button>
                    </div>
                    <div class="d-grid col-6 gap-2 mx-1">
                        <button class="btn btn-info" id="exit" href="#" data-bs-dismiss="modal">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Scripts -->
    <script type="text/javascript">
        let spinner = document.getElementById("spinner-wrapper")
        let data = document.getElementById("content")

        async function getData(){

            /**
             * Getting URL to request DATA
             */
            var url = window.location.href;
            const arr_url = url.split("/")
            const urlBase = `http://localhost:8080/api/${arr_url[3]}/${arr_url[4]}/mais_info`

            const response = await fetch(urlBase) // Fetching the URL given
            const data = await response.json() // Response DATA
            console.log(data)

            /**
             * Querying the HTML DOM to get Specific Elements
             */
            let nome_bomba = document.getElementById("nomeBomba")
            let horario_ = document.getElementById("horario")
            let morada = document.getElementById("morada")
            let go_simples = document.getElementById("gasoleo_simples")
            let go_aditivado = document.getElementById("gasoleo_aditivado")
            let ga_simples = document.getElementById("gasolina_simples")
            let ga_aditivada = document.getElementById("gasolina_aditivada")
            let ga_98 = document.getElementById("gasolina_98")

            let title = ""
            let horario_semana = ""
            let domingos = ""
            let address = ""

            let gasoleo_simples = ""
            let gasoleo_aditivado = ""
            let gasolina_simples = ""
            let gasolina_aditivada = ""
            let gasolina_98 = ""

            /**
             * Populating DATA
             */
            for (const info of data){
                title += `${info.bomba}`

                horario_semana += `<div class="col-lg-12 mx-2 border-0 text-dark">${info.horario_semana}</div>`

                domingos += `<div class="border-0 mx-2 col-lg-12 text-dark">${info.domingos}</div>`

                address += `<div class="border-0 mx-2 col-lg-12 text-dark">${info.morada}</div>`
                
                gasoleo_simples += `${info.gasoleo_simples}`
                gasoleo_aditivado += `${info.gasoleo_especial}`
                gasolina_simples += `${info.gasolina_simples}`
                gasolina_aditivada += `${info.gasolina_especial}`
                gasolina_98 += `${info.gasolina_98}`
            }

            nome_bomba.innerText = title
            horario_.innerHTML = horario_semana
            horario_.innerHTML += domingos
            morada.innerHTML = address
            go_simples.innerText = gasoleo_simples.slice(0, 5) + '€'
            go_aditivado.innerText = gasoleo_aditivado.slice(0, 5) + '€'
            ga_simples.innerText = gasolina_simples.slice(0, 5) + '€'
            ga_aditivada.innerText = gasolina_aditivada.slice(0, 5) + '€'
            ga_98.innerText = gasolina_98.slice(0, 5) + '€'
        }

        window.addEventListener("load", () => {
            data.style.display = 'none';
            getData()
                .then(() => {
                    spinner.remove()
                    data.style.display = 'block'
                }).catch((err) => { console.log(err) })
        })
    </script>

    <!-- Check for user authetication in Session-->
    <script>
        // Variaveis DOM
        let loginButton = document.getElementById('login')
        let registerButton = document.getElementById('registar')
        let logoutButton = document.getElementById('logout')
        loginButton.classList.add('is-visible')
        registerButton.classList.add('is-visible')

        document.addEventListener("DOMContentLoaded", () => {
            getBP().then(getGALP()).catch((err) => console.log(err))
        })
        window.addEventListener("load", () => {
            let user = sessionStorage.getItem("user")
            let token = sessionStorage.getItem("token")
            if (user != null && token != null){
                logoutButton.classList.add('is-visible')
                loginButton.classList.remove('is-visible')
                registerButton.classList.remove('is-visible')
            }
        })
    </script>

    <!-- Script Login -->
    <script>
        // Variavei DOM
        let loginForm = document.getElementById("submitLogin")
        let loginWarning = document.getElementById("loginWarning")
        let passwordWarning = document.getElementById("passwordLoginWarning")

        loginForm.addEventListener('click', () => {
            let username = document.getElementById("usernameLogin").value
            let password = document.getElementById("passwordLogin").value

            if (password == '' || username == ''){
                loginWarning.classList.add('is-visible')
                setTimeout(() => {
                loginWarning.classList.remove('is-visible')
                }, 2500)
            }
            else {
                let authentication = {
                'username': username,
                'password': password
                }
                let auth = JSON.stringify(authentication)
                
                fetch('http://localhost:8080/api/userLogin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', 
                    },
                    body: auth,

                }).then( async (response) => {
                    if (response.status == 401){
                        loginWarning.classList.add('is-visible')
                        setTimeout(() => {
                        loginWarning.classList.remove('is-visible')
                        }, 2500)
                    }
                    else if (response.status == 403) {
                        passwordWarning.classList.add('is-visible')
                        setTimeout(() => {
                        passwordWarning.classList.remove('is-visible')
                        }, 2500)
                    }
                    else if (response.status == 200) {
                        const auth = await response.json()
                        sessionStorage.setItem("user", auth.user)
                        sessionStorage.setItem("token", auth.token)
                        document.getElementById("usernameRegister").value = ""
                        document.getElementById("passwordRegister").value= ""
                        location.reload()
                    }
                }).catch((err) => { console.log(err) })
            }            
        })
    </script>

    <!-- Script Register -->
    <script>
        // Variaveis DOM
        let registerForm = document.getElementById("submitRegister")
        let alert = document.getElementById("alert")
        let alert_warning = document.getElementById("warning")

        // Evento de register
        registerForm.addEventListener("click", () => {
            let username = document.getElementById("usernameRegister").value
            let password = document.getElementById("passwordRegister").value

            if (username === '' || password === '') {
                alert_warning.classList.add('is-visible')
                setTimeout(() => {
                   alert_warning.classList.remove('is-visible')
                }, 2500)
            }
            else {
                let authentication = {
                'username': username,
                'password': password
                }
                let auth = JSON.stringify(authentication)
                
                fetch('/api/userRegister', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', 
                    },
                    body: auth,
                }).then((response) => {
                    if (response.status == 201){
                        alert.classList.add('is-visible')
                        setTimeout(() => {
                            alert.classList.remove('is-visible')
                            document.getElementById("usernameRegister").value = ""
                            document.getElementById("passwordRegister").value= ""
                        }, 2500)
                    }
                }).catch((err) => { console.log(err) })
            }            
        })
    </script>

    <!-- Logout -->
    <script>
        // Variaveis DOM
        let exit = document.getElementById("exit")
        let lbutton = document.getElementById('login')
        let rButton = document.getElementById('registar')
        let loButton = document.getElementById('logout')
        
        exit.addEventListener("click", () => {
            sessionStorage.removeItem("user")
            sessionStorage.removeItem("token")
            location.reload()
        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>

</html>